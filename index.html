<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Naval Intelligence: Campaign Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        :root {
            --radar-green: #00ff41;
            --radar-bg: #0d1117;
            --radar-dim: rgba(0, 255, 65, 0.2);
            --ppt-bg: #001B33;
            --ppt-accent: #00A8C6;
            --ppt-text: #E6F1F5;
        }

        body {
            background-color: #000;
            color: var(--radar-green);
            font-family: 'Share Tech Mono', monospace;
            overflow: hidden;
            height: 100dvh;
            width: 100vw;
        }

        /* --- FLAG CSS --- */
        .flag-container { display: flex; justify-content: center; margin-bottom: 1rem; filter: drop-shadow(0 0 10px rgba(255, 153, 51, 0.4)); }
        .stripe { width: 120px; height: 25px; }
        #saffron { background: #FF9933; border-top-left-radius: 3px; border-top-right-radius: 3px; }
        #white { background: #FFFFFF; display: flex; justify-content: center; align-items: center; }
        #green { background: #138808; border-bottom-left-radius: 3px; border-bottom-right-radius: 3px; }
        .ashok_chakra { height: 20px; width: 20px; animation: spin-slow 10s linear infinite; }

        .flag-icon-container { display: inline-flex; flex-direction: column; margin-right: 0.5rem; vertical-align: middle; filter: drop-shadow(0 0 5px rgba(255, 153, 51, 0.4)); }
        .stripe-icon { width: 36px; height: 8px; }
        #saffron-icon { background: #FF9933; border-top-left-radius: 2px; border-top-right-radius: 2px; }
        #white-icon { background: #FFFFFF; display: flex; justify-content: center; align-items: center; }
        #green-icon { background: #138808; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; }
        .ashok_chakra-icon { height: 6px; width: 6px; animation: spin-slow 10s linear infinite; }

        /* CRT Effects */
        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px; position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 50;
        }
        .grid-bg {
            background-image: linear-gradient(var(--radar-dim) 1px, transparent 1px), linear-gradient(90deg, var(--radar-dim) 1px, transparent 1px);
            background-size: 40px 40px; width: 100%; height: 100%; position: absolute; z-index: -1; opacity: 0.3;
        }

        /* Animations */
        .radar-sweep {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0deg, var(--radar-dim) 60deg, transparent 65deg);
            animation: sweep 4s infinite linear; border-right: 1px solid var(--radar-green); z-index: 10;
        }
        @keyframes sweep { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .blip { position: absolute; width: 8px; height: 8px; background-color: var(--radar-green); border-radius: 50%; box-shadow: 0 0 5px var(--radar-green); opacity: 0; animation: blink 4s infinite; }
        @keyframes blink { 0% { opacity: 0; } 15% { opacity: 1; } 40% { opacity: 0; } 100% { opacity: 0; } }

        .glitch-text:hover { text-shadow: 2px 0 #fff, -2px 0 #ff00c1; }
        .typing-cursor::after { content: '█'; animation: cursor 1s infinite; }
        @keyframes cursor { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* Map & Boat Styles */
        #tactical-boat { 
            transition: left 0.1s linear, top 0.1s linear, transform 0.2s ease; 
        }
        
        .map-node { cursor: pointer; transition: all 0.3s ease; }
        .map-node:hover { transform: scale(1.3); filter: drop-shadow(0 0 8px var(--radar-green)); }
        .map-node.active { background-color: #fff; box-shadow: 0 0 15px #fff; }

        /* Water Flow Animation */
        @keyframes flow {
            from { stroke-dashoffset: 50; }
            to { stroke-dashoffset: 0; }
        }
        .river-flow {
            stroke-dasharray: 10 5;
            animation: flow 1s linear infinite;
        }

        /* Flag Raising Animation */
        @keyframes raise {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -100%) scale(1); opacity: 1; }
        }
        .animate-raise { animation: raise 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #001100; }
        ::-webkit-scrollbar-thumb { background: #004400; }

        /* PPT Styles */
        .ppt-container {
            background-color: var(--ppt-bg);
            color: var(--ppt-text);
            font-family: sans-serif; /* Clean font for slides */
        }
        .ppt-title { color: var(--ppt-accent); }
    </style>
</head>
<body class="flex flex-col h-[100dvh] relative overflow-hidden">

    <div class="scanlines"></div>
    <div class="grid-bg"></div>

    <!-- SCREEN 1: INTRO -->
    <div id="intro-screen" class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center transition-opacity duration-1000 px-4">
        <div class="text-center mb-10 md:mb-[88px] w-full max-w-4xl">
            <div class="flag-container">
                <div id="flag">
                    <div class="stripe" id="saffron"></div>
                    <div class="stripe" id="white">
                        <img class="ashok_chakra" src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/Ashoka_Chakra.svg/630px-Ashoka_Chakra.svg.png" alt="Ashoka Chakra">
                    </div>
                    <div class="stripe" id="green"></div>
                </div>
            </div>
            <h1 class="text-3xl md:text-6xl font-bold tracking-widest mb-2 text-green-500 glitch-text uppercase">Naval Intelligence</h1>
            <p class="text-xs md:text-sm tracking-[0.3em] md:tracking-[0.5em] animate-pulse">UNIDENTIFIED VESSEL DETECTED</p>
        </div>

        <div class="relative group cursor-pointer" onclick="goToMap()">
            <div class="absolute -inset-4 bg-green-500/20 rounded-2xl animate-ping opacity-20"></div>
            <div class="absolute -inset-1 border border-green-500/50 rounded-2xl animate-pulse"></div>
            <img src="assets/intro-navy.png" alt="Identify Target" class="relative z-10 w-full max-w-[280px] md:max-w-[320px] h-auto rounded-2xl border-2 border-green-500 shadow-[0_0_20px_rgba(0,255,65,0.3)] hover:scale-105 hover:shadow-[0_0_30px_rgba(0,255,65,0.6)] transition-all duration-300">
            <p class="mt-4 text-center text-xs text-green-400">[ CLICK TO ACCESS TACTICAL MAP ]</p>
        </div>
    </div>

    <!-- SCREEN 2: TACTICAL RIVER MAP -->
    <div id="map-screen" class="absolute inset-0 z-40 bg-black flex flex-col items-center justify-center transition-opacity duration-1000 opacity-0 pointer-events-none p-4 overflow-hidden">
        <h2 class="text-2xl md:text-4xl font-bold text-green-500 mb-8 border-b border-green-800 pb-2">SELECT OPERATION DAY</h2>
        
        <!-- Aspect Ratio Container (2:1) -->
        <div class="relative w-full max-w-5xl aspect-[2/1] border border-green-800 bg-green-900/10 rounded-lg relative shadow-[0_0_50px_rgba(0,255,65,0.1)]">
            
            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 800 400" preserveAspectRatio="none">
                <path d="M 50 350 C 150 350, 150 250, 250 250 C 350 250, 350 320, 450 300 C 550 280, 550 150, 650 150 C 750 150, 750 50, 780 50" 
                      fill="none" stroke="rgba(0, 50, 0, 0.5)" stroke-width="40" stroke-linecap="round" class="filter blur-sm"/>
                <path d="M 50 350 C 150 350, 150 250, 250 250 C 350 250, 350 320, 450 300 C 550 280, 550 150, 650 150 C 750 150, 750 50, 780 50" 
                      fill="none" stroke="rgba(0, 255, 65, 0.6)" stroke-width="3" class="river-flow" />
                <path d="M 50 360 C 150 360, 150 260, 250 260 C 350 260, 350 330, 450 310 C 550 290, 550 160, 650 160 C 750 160, 750 60, 780 60" 
                      fill="none" stroke="rgba(0, 255, 65, 0.3)" stroke-width="1" class="river-flow" style="animation-direction: reverse; animation-duration: 2s;" />
            </svg>

            <!-- Checkpoints -->
            <div class="absolute left-[6%] top-[87%] text-center">
                <div class="w-4 h-4 bg-green-500 rounded-full shadow-[0_0_10px_#0f0]"></div>
                <div class="text-[10px] mt-1 text-green-300">HQ</div>
            </div>

            <div onclick="selectDay(1)" class="absolute left-[31%] top-[62%] text-center group cursor-pointer map-node">
                <div class="w-6 h-6 bg-black border-2 border-green-500 rounded-full flex items-center justify-center group-hover:bg-green-500 transition-colors">1</div>
                <div class="text-xs mt-1 font-bold bg-black/50 px-1">DAY 01</div>
            </div>

            <div onclick="selectDay(2)" class="absolute left-[56%] top-[75%] text-center group cursor-pointer map-node">
                <div class="w-6 h-6 bg-black border-2 border-green-500 rounded-full flex items-center justify-center group-hover:bg-green-500 transition-colors">2</div>
                <div class="text-xs mt-1 font-bold bg-black/50 px-1">DAY 02</div>
            </div>
            
            <div onclick="selectDay(3)" class="absolute left-[69%] top-[37%] text-center group cursor-pointer map-node">
                <div class="w-6 h-6 bg-black border-2 border-green-500 rounded-full flex items-center justify-center group-hover:bg-green-500 transition-colors">3</div>
                <div class="text-xs mt-1 font-bold bg-black/50 px-1">DAY 03</div>
            </div>

            <div onclick="selectDay(4)" class="absolute left-[81%] top-[37%] text-center group cursor-pointer map-node">
                <div class="w-6 h-6 bg-black border-2 border-green-500 rounded-full flex items-center justify-center group-hover:bg-green-500 transition-colors">4</div>
                <div class="text-xs mt-1 font-bold bg-black/50 px-1">DAY 04</div>
            </div>

            <div onclick="selectDay(5)" class="absolute left-[95%] top-[12%] text-center group cursor-pointer map-node">
                <div class="w-6 h-6 bg-black border-2 border-green-500 rounded-full flex items-center justify-center group-hover:bg-green-500 transition-colors">5</div>
                <div class="text-xs mt-1 font-bold bg-black/50 px-1">DAY 05</div>
            </div>

            <!-- BOAT -->
            <div id="tactical-boat" class="absolute w-16 h-16 drop-shadow-[0_0_8px_rgba(0,255,65,0.6)] z-20 pointer-events-none" style="left: 6%; top: 85%; transform: translate(-50%, -50%) rotate(0deg);">
                <svg viewBox="0 0 100 240" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full text-green-400 opacity-90">
                    <path d="M50 0 C 50 0 90 40 90 140 C 90 220 70 240 50 240 C 30 240 10 220 10 140 C 10 40 50 0 50 0 Z" fill="#001a00" stroke="currentColor" stroke-width="2"/>
                    <rect x="35" y="80" width="30" height="80" rx="2" fill="currentColor" opacity="0.5" />
                    <circle cx="50" cy="60" r="10" stroke="currentColor" stroke-width="2"/>
                    <line x1="50" y1="60" x2="50" y2="30" stroke="currentColor" stroke-width="2"/>
                    <rect x="40" y="170" width="20" height="20" fill="currentColor" opacity="0.3"/>
                    <path d="M42 172 L58 188 M58 172 L42 188" stroke="currentColor" stroke-width="1"/>
                    <path d="M20 230 L5 250 M80 230 L95 250" stroke="currentColor" stroke-width="1" opacity="0.5"/>
                </svg>
            </div>

            <!-- FLAG -->
            <div id="victory-flag" class="absolute hidden z-30 flex-col items-center">
                <div class="flex flex-col shadow-[0_0_10px_rgba(255,153,51,0.8)]">
                     <div class="w-12 h-3 bg-[#FF9933] rounded-t-[1px]"></div>
                     <div class="w-12 h-3 bg-white flex justify-center items-center">
                         <div class="w-2 h-2 rounded-full bg-blue-800 animate-spin"></div>
                     </div>
                     <div class="w-12 h-3 bg-[#138808] rounded-b-[1px]"></div>
                </div>
                <div class="w-0.5 h-10 bg-gray-400"></div>
            </div>

        </div>
        <p class="mt-4 text-green-400 text-sm animate-pulse">SELECT A DAY TO BEGIN</p>
    </div>

    <!-- SCREEN 3: DASHBOARD -->
    <div id="dashboard-screen" class="absolute inset-0 z-30 flex flex-col md:flex-row p-4 gap-4 opacity-0 pointer-events-none transition-opacity duration-1000 bg-black">
        
        <!-- Left Panel: Sonar Array -->
        <div class="w-full md:w-1/3 flex flex-col items-center justify-center border border-green-800 bg-black/80 relative p-4 rounded-lg shadow-[0_0_15px_rgba(0,255,65,0.1)]">
            <h2 class="absolute top-4 left-4 text-xl font-bold border-b border-green-600 pb-1 flex items-center">
                <div onclick="backToMap()" class="flag-icon-container cursor-pointer hover:opacity-80 hover:scale-105 transition-all" title="Click to Return to Map">
                    <div class="stripe-icon" id="saffron-icon"></div>
                    <div class="stripe-icon" id="white-icon">
                        <img class="ashok_chakra-icon" src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/Ashoka_Chakra.svg/630px-Ashoka_Chakra.svg.png" alt="Ashoka Chakra">
                    </div>
                    <div class="stripe-icon" id="green-icon"></div>
                </div>
                <span id="dashboard-header">SONAR ARRAY</span>
            </h2>
            
            <div class="relative w-64 h-64 md:w-80 md:h-80 rounded-full border-2 border-green-900 bg-green-900/10 overflow-hidden shadow-inner mt-8 md:mt-0" id="radar-container">
                <div class="absolute inset-0 border border-green-900/50 rounded-full m-8"></div>
                <div class="absolute inset-0 border border-green-900/50 rounded-full m-16"></div>
                <div class="absolute inset-0 border border-green-900/50 rounded-full m-24"></div>
                <div class="absolute inset-0 flex items-center justify-center"><div class="w-full h-px bg-green-900/50"></div></div>
                <div class="absolute inset-0 flex items-center justify-center"><div class="h-full w-px bg-green-900/50"></div></div>
                <div class="radar-sweep" id="scanner"></div>
                <div class="absolute top-1/2 left-1/2 w-2 h-2 bg-green-500 rounded-full -translate-x-1/2 -translate-y-1/2 shadow-[0_0_10px_#00ff41]"></div>
                <div id="blip-container"></div>
            </div>

            <div class="mt-6 w-full">
                <div class="flex justify-between text-xs text-green-700 mb-1">
                    <span>STATUS: <span id="current-day-label" class="text-green-400 font-bold">DAY 01</span></span>
                    <span>COORDS: <span id="coords">34.55, -12.01</span></span>
                </div>
                <div class="h-2 w-full bg-green-900/30 rounded-full overflow-hidden">
                    <div class="h-full bg-green-500 w-2/3 animate-pulse"></div>
                </div>
            </div>
            
            <button onclick="backToMap()" class="mt-4 border border-red-900 text-red-500 hover:bg-red-900/30 px-4 py-2 rounded text-xs w-full transition-colors">
                ABORT / RETURN TO MAP
            </button>
        </div>

        <!-- Right Panel: Intel & Communication -->
        <div class="w-full md:w-2/3 flex flex-col gap-4">
            <!-- Buttons specific to the module (e.g., Presentation, Labs) -->
            <div id="module-buttons-container" class="flex flex-wrap gap-2 p-2 border border-green-800 bg-black/80 rounded-lg"></div>
            
            <!-- Main Content Viewer -->
            <div class="flex-1 border border-green-800 bg-black/90 p-6 rounded-lg relative shadow-[inset_0_0_20px_rgba(0,20,0,1)] font-mono flex flex-col overflow-hidden">
                <div class="absolute top-2 right-2 flex gap-1 z-20">
                    <div class="w-3 h-3 rounded-full bg-red-500 opacity-50"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500 opacity-50"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500 opacity-100"></div>
                </div>

                <div id="content-display" class="h-full flex flex-col relative">
                    <h3 id="module-title" class="text-2xl font-bold mb-4 border-b border-green-800 pb-2 text-green-300">INITIALIZING...</h3>
                    
                    <!-- Content Container (Scrollable) -->
                    <div id="module-content-area" class="flex-1 overflow-y-auto pr-2 relative custom-scroll">
                        <!-- Initial Message -->
                        <p id="module-text" class="text-green-400 leading-relaxed whitespace-pre-line">
                           Select a module above to initiate data link...
                        </p>
                    </div>

                    <div class="mt-4 pt-4 border-t border-green-800 text-xs text-green-600 flex justify-between">
                        <span>SECURE CONNECTION ESTABLISHED</span>
                        <span id="timestamp">00:00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // DATA SOURCES (MANIFEST)
        // ==========================================
        
        // This manifest maps Module Buttons to External JSON files.
        // NOTE: For this to work locally, you must run a local server (e.g., python -m http.server)
        // or use an environment that supports fetch from relative paths.
        
        const missionData = {
            1: {
                // Day 1: Modules 1-4
                modules: [
                   { id: 1, label: 'MOD 01', src: 'assets/json/mod-1.json' },
                   { id: 2, label: 'MOD 02', src: 'assets/json/mod-2.json' },
                   { id: 3, label: 'MOD 03', src: 'assets/json/mod-3.json' },
                   { id: 4, label: 'MOD 04', src: 'assets/json/mod-4.json' }
                ]
            },
            2: {
                 // Day 2: Modules 5-8
                 modules: [
                    { id: 5, label: 'MOD 05', src: 'assets/json/mod-5.json' },
                    { id: 6, label: 'MOD 06', src: 'assets/json/mod-6.json' },
                    { id: 7, label: 'MOD 07', src: 'assets/json/mod-7.json' },
                    { id: 8, label: 'MOD 08', src: 'assets/json/mod-8.json' }
                 ]
            },
            3: {
                 // Day 3: Modules 5-8
                 modules: [
                    { id: 9, label: 'MOD 09', src: 'assets/json/mod-9.json' },
                    { id: 10, label: 'MOD 10', src: 'assets/json/mod-10.json' },
                    { id: 11, label: 'MOD 11', src: 'assets/json/mod-11.json' },
                    { id: 12, label: 'MOD 12', src: 'assets/json/mod-12.json' }
                 ]
            },
            4: {
                 // Day 3: Modules 5-8
                 modules: [
                     { id: 13, label: 'MOD 13', src: 'assets/json/mod-13.json' },
                     { id: 14, label: 'MOD 14', src: 'assets/json/mod-14.json' },
                     { id: 15, label: 'MOD 15', src: 'assets/json/mod-15.json' },
                     { id: 16, label: 'MOD 16', src: 'assets/json/mod-16.json' }
                     ]
            },
            5: {
                 // Day 3: Modules 5-8
                 modules: [
                     { id: 17, label: 'MOD 17', src: 'assets/json/mod-17.json' },
                     { id: 18, label: 'MOD 18', src: 'assets/json/mod-18.json' },
                     { id: 19, label: 'MOD 19', src: 'assets/json/mod-19.json' },
                     { id: 20, label: 'MOD 20', src: 'assets/json/mod-20.json' }
                     ]
            },
            // Fallback for days 3-5 (You can expand this pattern)
            default: {
                modules: [
                    { id: 99, label: 'LOCKED', src: null }
                ]
            }
        };

        const mapCoords = {
            0: { left: '6%', top: '85%' },   // Start
            1: { left: '31%', top: '62%' },  // Day 1
            2: { left: '56%', top: '75%' },  // Day 2
            3: { left: '69%', top: '37%' },  // Day 3
            4: { left: '81%', top: '37%' },  // Day 4
            5: { left: '95%', top: '12%' }   // Day 5
        };

        const riverWaypoints = [
            { left: '6%', top: '85%', deg: 0 },    
            { left: '18%', top: '85%', deg: 90 },  
            { left: '25%', top: '70%', deg: 45 },  
            { left: '31%', top: '62%', deg: 45 },  // DAY 1
            { left: '40%', top: '65%', deg: 135 }, 
            { left: '43%', top: '80%', deg: 180 }, 
            { left: '56%', top: '75%', deg: 90 },  // DAY 2
            { left: '62%', top: '60%', deg: 0 },   
            { left: '69%', top: '37%', deg: 0 },   // DAY 3
            { left: '81%', top: '37%', deg: 90 },  // DAY 4
            { left: '88%', top: '25%', deg: 45 },  
            { left: '95%', top: '12%', deg: 0 }    // DAY 5
        ];

        let typingTimeout = null;
        let currentDayModules = []; 
        let currentModuleData = null; // Store fetched data
        let slideGalleryState = {}; 

        function goToMap() {
            document.getElementById('intro-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('intro-screen').style.display = 'none';
                const mapScreen = document.getElementById('map-screen');
                mapScreen.style.opacity = '1';
                mapScreen.style.pointerEvents = 'all';
            }, 1000);
        }

        // --- NAVIGATOR FUNCTION ---
        function selectDay(targetDayNum) {
            const boat = document.getElementById('tactical-boat');
            
            let targetIndex = -1;
            const targetCoord = mapCoords[targetDayNum];
            
            for(let i=0; i<riverWaypoints.length; i++) {
                if(riverWaypoints[i].left === targetCoord.left && riverWaypoints[i].top === targetCoord.top) {
                    targetIndex = i;
                    break;
                }
            }

            if (targetIndex === -1) return; 

            let currentIndex = 0;
            boat.style.left = riverWaypoints[0].left;
            boat.style.top = riverWaypoints[0].top;
            boat.style.transform = `translate(-50%, -50%) rotate(${riverWaypoints[0].deg}deg)`;

            const TOTAL_TRAVEL_TIME = 1500; 
            const stepDelay = TOTAL_TRAVEL_TIME / targetIndex; 

            boat.style.transition = `left ${stepDelay}ms linear, top ${stepDelay}ms linear, transform ${stepDelay}ms linear`;

            function step() {
                if (currentIndex >= targetIndex) {
                    setTimeout(() => triggerFlag(targetDayNum), 200);
                    return;
                }
                
                currentIndex++;
                const point = riverWaypoints[currentIndex];
                boat.style.left = point.left;
                boat.style.top = point.top;
                boat.style.transform = `translate(-50%, -50%) rotate(${point.deg || 0}deg)`;
                
                setTimeout(step, stepDelay); 
            }
            
            setTimeout(step, 100);
        }

        function triggerFlag(dayNum) {
            const flag = document.getElementById('victory-flag');
            const targetCoord = mapCoords[dayNum];
            
            flag.style.left = targetCoord.left;
            flag.style.top = targetCoord.top;
            
            flag.classList.remove('hidden');
            flag.classList.add('animate-raise');

            setTimeout(() => {
                loadDashboard(dayNum);
                setTimeout(() => {
                    flag.classList.add('hidden');
                    flag.classList.remove('animate-raise');
                    const boat = document.getElementById('tactical-boat');
                    boat.style.left = '6%';
                    boat.style.top = '85%';
                    boat.style.transform = `translate(-50%, -50%) rotate(0deg)`;
                }, 1000);
            }, 1200);
        }

        function loadDashboard(dayNum) {
            const mapScreen = document.getElementById('map-screen');
            mapScreen.style.opacity = '0';
            mapScreen.style.pointerEvents = 'none';

            const dashScreen = document.getElementById('dashboard-screen');
            dashScreen.style.display = 'flex'; 
            setTimeout(() => {
                dashScreen.style.opacity = '1';
                dashScreen.style.pointerEvents = 'all';
            }, 100);

            document.getElementById('current-day-label').innerText = `DAY ${dayNum.toString().padStart(2,'0')}`;
            const btnContainer = document.getElementById('module-buttons-container');
            btnContainer.innerHTML = ''; 
            
            // Load Data for the selected DAY
            const dayData = missionData[dayNum] || missionData['default'];
            currentDayModules = dayData.modules || [];

            // Create buttons for each Module
            currentDayModules.forEach((mod, index) => {
                const btn = document.createElement('button');
                btn.className = "min-w-[100px] py-2 px-3 border border-green-700 hover:bg-green-900 text-xs md:text-sm transition-colors text-left flex items-center gap-2 group text-green-400";
                
                // If it's a locked module, disable click
                if(mod.src === null) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = `<div class="w-2 h-2 bg-red-500 rounded-full"></div> ${mod.label}`;
                } else {
                    btn.onclick = () => fetchAndRenderModule(mod);
                    btn.innerHTML = `<div class="w-2 h-2 bg-green-500 rounded-full opacity-50 group-hover:opacity-100"></div> ${mod.label}`;
                }
                btnContainer.appendChild(btn);
            });

            createRandomBlips(3 + dayNum); 
            
            // Auto-load first module content if available
            if(currentDayModules.length > 0 && currentDayModules[0].src !== null) {
                fetchAndRenderModule(currentDayModules[0]);
            }
        }

        function backToMap() {
            const dashScreen = document.getElementById('dashboard-screen');
            dashScreen.style.opacity = '0';
            dashScreen.style.pointerEvents = 'none';
            
            const mapScreen = document.getElementById('map-screen');
            mapScreen.style.opacity = '1';
            mapScreen.style.pointerEvents = 'all';
        }

        // --- ASYNC FETCH & RENDER ---
        async function fetchAndRenderModule(moduleConfig) {
            const contentArea = document.getElementById('module-content-area');
            const titleEl = document.getElementById('module-title');
            
            // 1. Show Loading State
            if(typingTimeout) clearTimeout(typingTimeout);
            titleEl.innerText = "ESTABLISHING SECURE LINK...";
            contentArea.innerHTML = `<p class="text-green-400 animate-pulse">> DECRYPTING DATA STREAM...</p>`;

            try {
                // 2. Fetch the JSON file
                const response = await fetch(moduleConfig.src);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                const json = await response.json();
                
                // 3. Render
                currentModuleData = json;
                titleEl.innerText = json.title || "CLASSIFIED MODULE";
                renderModuleContent();

            } catch (error) {
                // 4. Handle Errors (File not found, CORS, etc.)
                console.error("Module Load Error:", error);
                titleEl.innerText = "CONNECTION FAILED";
                contentArea.innerHTML = `
                    <div class="text-red-500 border border-red-500 p-4 rounded bg-red-900/20">
                        <h3 class="font-bold mb-2">ERROR: DATA LINK SEVERED</h3>
                        <p class="text-sm">Unable to load module data from: <br><span class="font-mono bg-black px-1">${moduleConfig.src}</span></p>
                        <br>
                        <p class="text-xs text-gray-400">DEBUG INFO: Ensure the JSON file exists in the 'assets/json/' folder and you are running a local server.</p>
                    </div>
                `;
            }
        }

        // --- SCROLLING MODULE ENGINE (Uses fetched JSON) ---
        function renderModuleContent() {
            const contentArea = document.getElementById('module-content-area');
            const blocks = currentModuleData.blocks || [];
            const theme = currentModuleData.theme || {};
            
            slideGalleryState = {}; // Reset Gallery State

            contentArea.innerHTML = '';
            
            const wrapper = document.createElement('div');
            wrapper.className = "flex flex-col gap-6 p-2 md:p-6 bg-[#001B33]/50 rounded-lg min-h-full";
            
            const accent = theme.accentColor || '#00A8C6';
            const text = theme.textColor || '#fff';
            
            let html = '';
            
            blocks.forEach((block, blockIndex) => {
                if (block.type === 'title') {
                    html += `<h1 class="text-2xl md:text-3xl font-bold text-center mb-6 pb-4 border-b border-[${accent}]/30" style="color:${accent}">${block.content}</h1>`;
                }
                else if (block.type === 'header') {
                    html += `<h2 class="text-lg md:text-xl font-bold mt-8 mb-2 border-l-4 pl-4" style="color:${accent}; border-color:${accent}">${block.content}</h2>`;
                }
                else if (block.type === 'text') {
                    html += `<div class="text-sm md:text-base leading-relaxed" style="color:${text}">${block.content}</div>`;
                } 
                else if (block.type === 'points') {
                    html += `<ul class="space-y-3 ml-2">
                        ${block.content.map(p => `
                            <li class="flex items-start gap-3 text-sm md:text-base" style="color:${text}">
                                <span style="color:${accent}" class="mt-1">•</span>
                                <span>${p}</span>
                            </li>
                        `).join('')}
                    </ul>`;
                }
                else if (block.type === 'gallery') {
                    const images = block.images || [];
                    if (images.length > 1) {
                        // Initialize state
                        slideGalleryState[blockIndex] = 0;
                        
                        // CAROUSEL RENDER
                        html += `
                            <div class="flex flex-col gap-2 my-4 items-center bg-black/30 rounded p-2 border border-[#00A8C6]/30">
                                <div class="relative w-full h-[250px] md:h-[400px] flex items-center justify-center">
                                    <img id="img-gallery-${blockIndex}" src="${images[0]}" class="max-w-full max-h-full object-contain">
                                </div>
                                <div class="flex gap-4">
                                    <button onclick="switchBlockImage(${blockIndex}, -1)" class="px-3 py-1 text-xs border border-[#00A8C6] text-[#00A8C6] hover:bg-[#00A8C6] hover:text-black rounded">&lt; PREV</button>
                                    <span id="counter-gallery-${blockIndex}" class="text-xs text-gray-400 self-center">1 / ${images.length}</span>
                                    <button onclick="switchBlockImage(${blockIndex}, 1)" class="px-3 py-1 text-xs border border-[#00A8C6] text-[#00A8C6] hover:bg-[#00A8C6] hover:text-black rounded">NEXT &gt;</button>
                                </div>
                            </div>
                        `;
                    } else if (images.length === 1) {
                        // SINGLE IMAGE RENDER
                        html += `
                            <div class="flex justify-center my-4">
                                <img src="${images[0]}" class="w-full max-h-[250px] md:max-h-[400px] object-contain bg-black/30 rounded border border-[#00A8C6]/30 shadow-lg">
                            </div>
                        `;
                    }
                }
            });

            // Add extra padding at bottom for easy scrolling
            html += `<div class="h-20"></div>`;

            wrapper.innerHTML = html;
            contentArea.appendChild(wrapper);
        }

        // --- GALLERY CAROUSEL LOGIC ---
        function switchBlockImage(blockIndex, direction) {
            if (!currentModuleData.blocks || !currentModuleData.blocks[blockIndex]) return;
            
            const images = currentModuleData.blocks[blockIndex].images;
            let currentIdx = slideGalleryState[blockIndex];
            
            let newIdx = currentIdx + direction;
            if (newIdx < 0) newIdx = images.length - 1;
            if (newIdx >= images.length) newIdx = 0;
            
            slideGalleryState[blockIndex] = newIdx;
            
            // Update DOM
            const imgEl = document.getElementById(`img-gallery-${blockIndex}`);
            const countEl = document.getElementById(`counter-gallery-${blockIndex}`);
            
            if(imgEl) imgEl.src = images[newIdx];
            if(countEl) countEl.innerText = `${newIdx + 1} / ${images.length}`;
        }

        function updateTime() {
            const now = new Date();
            const timeSpan = document.getElementById('timestamp');
            if(timeSpan) timeSpan.innerText = now.toISOString().split('T')[1].split('.')[0] + " ZULU";
            
            const coordSpan = document.getElementById('coords');
            if(coordSpan && Math.random() > 0.5) {
                coordSpan.innerText = (Math.random() * 90).toFixed(2) + ", " + (Math.random() * 180 * -1).toFixed(2);
            }
        }

        function createRandomBlips(count) {
            const container = document.getElementById('blip-container');
            container.innerHTML = '';
            for(let i=0; i<count; i++) {
                const blip = document.createElement('div');
                blip.className = 'blip';
                const top = 20 + Math.random() * 60;
                const left = 20 + Math.random() * 60;
                blip.style.animationDelay = (Math.random() * 2) + 's';
                blip.style.top = top + '%';
                blip.style.left = left + '%';
                container.appendChild(blip);
            }
        }

        setInterval(updateTime, 1000);
    </script>
</body>
</html>
